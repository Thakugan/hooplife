<?php

header('Content-type: application/json');
use Slim\Http\Request;
use Slim\Http\Response;

// Show all comments for a game, location, or user
$app->get('/{type}/{id}/comments', function(Request $request, Response $response, array $args){
  if ($args['type'] == "game") {
    $sql = "SELECT * FROM comments JOIN games WHERE comments.GameID=games.GameID AND comments.GameID=:id ORDER BY Date";
  } else if ($args['type'] == "location") {
    $sql = "SELECT * FROM comments JOIN location WHERE comments.locationID=location.locationID AND comments.locationID=:id ORDER BY Date";
  } else if ($args['type'] == "user") {
    $sql = "SELECT * FROM comments JOIN users WHERE comments.username=users.username AND comments.target_username=:id ORDER BY Date";
  } else {
    return $this->response->withStatus(404);
  }
  $pdo = $this->db->prepare($sql);
  $pdo->bindParam("id", $args['id']);
  $pdo->execute();
  $comments = $pdo->fetchAll();
	return $this->response->withJson($comments);
});

// Post a new comment
$app->post('/{type}/{id}/new-commment', function(Request $request, Response $response, array $args){
  $input = $request->getParsedBody();

  $sql = "INSERT INTO comments (username, Comment, Date, URL, target_id, :id_from_table) VALUES (:username, :Comment, CURRENT_TIMESTAMP, :URL, :target_id, :id)";
  $pdo = $this->db->prepare($sql);
  $pdo->bindParam("username", $input["username"]);
  $pdo->bindParam("Comment", $input["Comment"]);
  $pdo->bindParam("URL", $input["URL"]);
  $pdo->bindParam("target_id", $input["target_id"]);
  if ($args['type'] == "game") {
    $g_id = "GameID";
    $pdo->bindParam("id_from_table", $g_id);
  } else if ($args['type'] == "location") {
    $l_id = "locationID";
    $pdo->bindParam("id_from_table", $l_id);
  } else if ($args['type'] == "user") {
    $user = "target_username";
    $pdo->bindParam("id_from_table", $user);
  } else {
    echo $args['type'];
    //return $this->response->withStatus(404);
  $pdo->bindParam("id", $args["id"]);
  $pdo->execute();
        return $this->response->withStatus(200);
});
